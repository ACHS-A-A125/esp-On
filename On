local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

local Settings = {
    ESP_TeamCheck = false,
    Username_Enabled = true,
    Fill_Color = Color3.fromRGB(0, 0, 255),
    Fill_Transparency = 0.7,
    Outline_Color = Color3.fromRGB(255, 0, 0),
    Outline_Transparency = 0.3,
    Max_Distance = 300000,
}

local heartbeatConnection = nil

function DisableESP()
    if heartbeatConnection then
        heartbeatConnection:Disconnect()
        heartbeatConnection = nil
    end
    for _, player in ipairs(Players:GetPlayers()) do
        if player.Character then
            local espHighlight = player.Character:FindFirstChild("ESPHighlight")
            if espHighlight then espHighlight:Destroy() end
            local head = player.Character:FindFirstChild("Head")
            if head then
                local billboardGui = head:FindFirstChild("PlayerESP_GUI")
                if billboardGui then billboardGui:Destroy() end
            end
        end
    end
end

function EnableESP()
    if heartbeatConnection then return end
    heartbeatConnection = RunService.Heartbeat:Connect(function()
        local localCharacter = LocalPlayer.Character
        if not localCharacter then return end
        local localRoot = localCharacter:FindFirstChild("HumanoidRootPart")
        if not localRoot then return end

        for _, player in ipairs(Players:GetPlayers()) do
            pcall(function()
                local character = player.Character
                if not character then return end
                local humanoid = character:FindFirstChildOfClass("Humanoid")
                local rootPart = character:FindFirstChild("HumanoidRootPart")
                local head = character:FindFirstChild("Head")
                local espHighlight = character:FindFirstChild("ESPHighlight")
                local billboardGui = head and head:FindFirstChild("PlayerESP_GUI")
                local isVisible = (player ~= LocalPlayer and humanoid and rootPart and humanoid.Health > 0)
                local isTeamCheckActive = Settings.ESP_TeamCheck and player.Team == LocalPlayer.Team
                local distance = rootPart and (localRoot.Position - rootPart.Position).Magnitude or math.huge

                if isVisible and not isTeamCheckActive and distance <= Settings.Max_Distance then
                    local highlight = espHighlight or Instance.new("Highlight", character)
                    highlight.Name = "ESPHighlight"
                    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                    highlight.FillColor = Settings.Fill_Color
                    highlight.FillTransparency = Settings.Fill_Transparency
                    highlight.OutlineColor = Settings.Outline_Color
                    highlight.OutlineTransparency = Settings.Outline_Transparency

                    if Settings.Username_Enabled and head then
                        local gui = billboardGui or Instance.new("BillboardGui", head)
                        gui.Name = "PlayerESP_GUI"
                        gui.AlwaysOnTop = true
                        gui.Size = UDim2.new(10, 0, 2, 0)
                        gui.StudsOffset = Vector3.new(0, 3, 0)
                        local textLabel = gui:FindFirstChild("NameLabel") or Instance.new("TextLabel", gui)
                        textLabel.Name = "NameLabel"
                        textLabel.BackgroundTransparency = 1
                        textLabel.Size = UDim2.new(1, 0, 1, 0)
                        textLabel.Text = player.DisplayName
                        textLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
                        textLabel.TextScaled = true
                        local textStroke = textLabel:FindFirstChild("TextStroke") or Instance.new("UIStroke", textLabel)
                        textStroke.Name = "TextStroke"
                        textStroke.Thickness = 1.5
                        textStroke.Color = Color3.new(0, 0, 0)
                    end
                else
                    if espHighlight then espHighlight:Destroy() end
                    if billboardGui then billboardGui:Destroy() end
                end
            end)
        end
    end)
end
